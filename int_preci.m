% Integral precision test

load('data/m1.txt');

%g = @(lam) integral(@(x) exp(lam' * [x.^0;x.^1;x.^2;x.^3;x.^4;x.^5;x.^6;x.^7;x.^8;x.^9;x.^10;x.^11;x.^12;x.^13;x.^14;x.^15;x.^16;x.^17;x.^18;x.^19;x.^20;x.^21;x.^22;x.^23;x.^24;x.^25;x.^26;x.^27;x.^28;x.^29;x.^30;x.^31;x.^32;x.^33;x.^34;x.^35;x.^36;x.^37;x.^38;x.^39;x.^40;x.^41;x.^42;x.^43;x.^44;x.^45;x.^46;x.^47;x.^48;x.^49;x.^50;x.^51;x.^52;x.^53;x.^54;x.^55;x.^56;x.^57;x.^58;x.^59;x.^60;x.^61;x.^62;x.^63;x.^64;x.^65;x.^66;x.^67;x.^68;x.^69;x.^70;x.^71;x.^72;x.^73;x.^74;x.^75;x.^76;x.^77;x.^78;x.^79;x.^80;x.^81;x.^82;x.^83;x.^84;x.^85;x.^86;x.^87;x.^88;x.^89;x.^90;x.^91;x.^92;x.^93;x.^94;x.^95;x.^96;x.^97;x.^98;x.^99;x.^100]), 0, 1) - lam'*m1;

g = @(lam) quadgk(@(x) exp(lam' * [x.^0;x.^1;x.^2;x.^3;x.^4;x.^5;x.^6;x.^7;x.^8;x.^9;x.^10;x.^11;x.^12;x.^13;x.^14;x.^15;x.^16;x.^17;x.^18;x.^19;x.^20;x.^21;x.^22;x.^23;x.^24;x.^25;x.^26;x.^27;x.^28;x.^29;x.^30;x.^31;x.^32;x.^33;x.^34;x.^35;x.^36;x.^37;x.^38;x.^39;x.^40;x.^41;x.^42;x.^43;x.^44;x.^45;x.^46;x.^47;x.^48;x.^49;x.^50;x.^51;x.^52;x.^53;x.^54;x.^55;x.^56;x.^57;x.^58;x.^59;x.^60;x.^61;x.^62;x.^63;x.^64;x.^65;x.^66;x.^67;x.^68;x.^69;x.^70;x.^71;x.^72;x.^73;x.^74;x.^75;x.^76;x.^77;x.^78;x.^79;x.^80;x.^81;x.^82;x.^83;x.^84;x.^85;x.^86;x.^87;x.^88;x.^89;x.^90;x.^91;x.^92;x.^93;x.^94;x.^95;x.^96;x.^97;x.^98;x.^99;x.^100]), 0, 1) - lam'*m1;

res1 = g(lam);

tic
res2 = guassian_quadrature64(@(x) f_int(x, lam) - lam'*m1);
t1 = toc;

tic
res3 = guassian_quadrature100(@(x) f_int(x, lam) - lam'*m1);
t2 = toc;

tic
nn = 15;
res4 = romberg_integral(@(x) f_int(x, lam) - lam'*m1, 0, 1, nn);
t3 = toc;

fprintf('default:%f  \n', res1);
fprintf('guass64:%f - %fs  \n', res2, t1);
fprintf('guass100:%f - %fs  \n', res3, t2);
fprintf('romberg:%d - %f - %fs\n', nn, res4, t3);

function [res] = guassian_quadrature64(f, ~, ~)
    % n is the number of nodes
    w = [0.0486909570091397,0.0486909570091397,0.0485754674415034,0.0485754674415034,0.0483447622348030,0.0483447622348030,0.0479993885964583,0.0479993885964583,0.0475401657148303,0.0475401657148303,0.0469681828162100,0.0469681828162100,0.0462847965813144,0.0462847965813144,0.0454916279274181,0.0454916279274181,0.0445905581637566,0.0445905581637566,0.0435837245293235,0.0435837245293235,0.0424735151236536,0.0424735151236536,0.0412625632426235,0.0412625632426235,0.0399537411327203,0.0399537411327203,0.0385501531786156,0.0385501531786156,0.0370551285402400,0.0370551285402400,0.0354722132568824,0.0354722132568824,0.0338051618371416,0.0338051618371416,0.0320579283548516,0.0320579283548516,0.0302346570724025,0.0302346570724025,0.0283396726142595,0.0283396726142595,0.0263774697150547,0.0263774697150547,0.0243527025687109,0.0243527025687109,0.0222701738083833,0.0222701738083833,0.0201348231535302,0.0201348231535302,0.0179517157756973,0.0179517157756973,0.0157260304760247,0.0157260304760247,0.0134630478967186,0.0134630478967186,0.0111681394601311,0.0111681394601311,0.00884675982636390,0.00884675982636390,0.00650445796897840,0.00650445796897840,0.00414703326056250,0.00414703326056250,0.00178328072169640,0.00178328072169640];
    x = 0.5.*[-0.0243502926634244,0.0243502926634244,-0.0729931217877990,0.0729931217877990,-0.121462819296120,0.121462819296120,-0.169644420423992,0.169644420423992,-0.217423643740007,0.217423643740007,-0.264687162208767,0.264687162208767,-0.311322871990211,0.311322871990211,-0.357220158337668,0.357220158337668,-0.402270157963991,0.402270157963991,-0.446366017253464,0.446366017253464,-0.489403145707053,0.489403145707053,-0.531279464019894,0.531279464019894,-0.571895646202634,0.571895646202634,-0.611155355172393,0.611155355172393,-0.648965471254657,0.648965471254657,-0.685236313054233,0.685236313054233,-0.719881850171610,0.719881850171610,-0.752819907260531,0.752819907260531,-0.783972358943341,0.783972358943341,-0.813265315122797,0.813265315122797,-0.840629296252580,0.840629296252580,-0.865999398154092,0.865999398154092,-0.889315445995114,0.889315445995114,-0.910522137078502,0.910522137078502,-0.929569172131939,0.929569172131939,-0.946411374858402,0.946411374858402,-0.961008799652053,0.961008799652053,-0.973326827789911,0.973326827789911,-0.983336253884626,0.983336253884626,-0.991013371476744,0.991013371476744,-0.996340116771955,0.996340116771955,-0.999305041735772,0.999305041735772]+0.5;

    %n = length(x);
    %ff = zeros(1, n);
    %for i = 1:n
    %    
    %    ff(i) = f(x(i));
    %end
    ff = arrayfun(f, x');
    res = 0.5 .* ff' * w';
end 

function [res] = guassian_quadrature100(f, ~, ~)
% n is the number of nodes

    w = [0.000734634490505672;0.00170939265351811;0.00268392537155348;0.00365596120132638;0.00462445006342212;0.00558842800386552;0.00654694845084532;0.00749907325546471;0.00844387146966897;0.00938041965369446;0.0103078025748690;0.0112251140231860;0.0121314576629795;0.0130259478929715;0.0139077107037188;0.0147758845274413;0.0156296210775460;0.0164680861761452;0.0172904605683236;0.0180959407221281;0.0188837396133749;0.0196530874944353;0.0204032326462094;0.0211334421125276;0.0218430024162474;0.0225312202563363;0.0231974231852541;0.0238409602659682;0.0244612027079571;0.0250575444815796;0.0256294029102081;0.0261762192395457;0.0266974591835710;0.0271926134465769;0.0276611982207924;0.0281027556591012;0.0285168543223951;0.0289030896011252;0.0292610841106383;0.0295904880599126;0.0298909795933328;0.0301622651051691;0.0304040795264548;0.0306161865839804;0.0307983790311526;0.0309504788504910;0.0310723374275665;0.0311638356962099;0.0312248842548494;0.0312554234538634;0.0312554234538634;0.0312248842548494;0.0311638356962099;0.0310723374275665;0.0309504788504910;0.0307983790311526;0.0306161865839804;0.0304040795264548;0.0301622651051691;0.0298909795933328;0.0295904880599126;0.0292610841106383;0.0289030896011252;0.0285168543223951;0.0281027556591012;0.0276611982207924;0.0271926134465769;0.0266974591835710;0.0261762192395457;0.0256294029102081;0.0250575444815796;0.0244612027079571;0.0238409602659682;0.0231974231852541;0.0225312202563363;0.0218430024162474;0.0211334421125276;0.0204032326462094;0.0196530874944353;0.0188837396133749;0.0180959407221281;0.0172904605683236;0.0164680861761452;0.0156296210775460;0.0147758845274413;0.0139077107037188;0.0130259478929715;0.0121314576629795;0.0112251140231860;0.0103078025748690;0.00938041965369446;0.00844387146966897;0.00749907325546471;0.00654694845084532;0.00558842800386552;0.00462445006342212;0.00365596120132638;0.00268392537155348;0.00170939265351811;0.000734634490505672];
    x = 0.5 + 0.5.*[-0.999713726773441;-0.998491950639596;-0.996295134733125;-0.993124937037443;-0.988984395242992;-0.983877540706057;-0.977809358486918;-0.970785775763706;-0.962813654255816;-0.953900782925492;-0.944055870136256;-0.933288535043080;-0.921609298145334;-0.909029570982530;-0.895561644970727;-0.881218679385018;-0.866014688497165;-0.849964527879591;-0.833083879888401;-0.815389238339176;-0.796897892390315;-0.777627909649496;-0.757598118519707;-0.736828089802021;-0.715338117573056;-0.693149199355802;-0.670283015603141;-0.646761908514129;-0.622608860203708;-0.597847470247179;-0.572501932621381;-0.546597012065094;-0.520158019881763;-0.493210789208191;-0.465781649773358;-0.437897402172032;-0.409585291678302;-0.380872981624630;-0.351788526372422;-0.322360343900529;-0.292617188038472;-0.262588120371504;-0.232302481844974;-0.201789864095736;-0.171080080538603;-0.140203137236114;-0.109189203580061;-0.0780685828134366;-0.0468716824215916;-0.0156289844215431;0.0156289844215431;0.0468716824215916;0.0780685828134366;0.109189203580061;0.140203137236114;0.171080080538603;0.201789864095736;0.232302481844974;0.262588120371504;0.292617188038472;0.322360343900529;0.351788526372422;0.380872981624630;0.409585291678302;0.437897402172032;0.465781649773358;0.493210789208191;0.520158019881763;0.546597012065094;0.572501932621381;0.597847470247179;0.622608860203708;0.646761908514129;0.670283015603141;0.693149199355802;0.715338117573056;0.736828089802021;0.757598118519707;0.777627909649496;0.796897892390315;0.815389238339176;0.833083879888401;0.849964527879591;0.866014688497165;0.881218679385018;0.895561644970727;0.909029570982530;0.921609298145334;0.933288535043080;0.944055870136256;0.953900782925492;0.962813654255816;0.970785775763706;0.977809358486918;0.983877540706057;0.988984395242992;0.993124937037443;0.996295134733125;0.998491950639596;0.999713726773441];
    %n = length(x);
    %ff = zeros(1, n);
    %for i = 1:n
    %    
    %    ff(i) = f(x(i));
    %end
    ff = arrayfun(f, x);
    res = 0.5 .* ff' * w;
end

function [res] = romberg_integral (f, start_, end_, n)
% n is the size of Romberg table

    % initialization
    h = end_ - start_;
    R = zeros(2, n);
    R(1, 1) = h/2 * (f(start_) + f(end_));

    for i = 2:n

        sum_ = sum(arrayfun(f, start_ + ((1:2^(i-2))-0.5)*h));
        R(2, 1) = 1/2 * (R(1, 1) + h*sum_);

        for j = 2:i
            R(2, j) = R(2, j-1) + (R(2, j-1)-R(1, j-1)) / (4^(j-1)-1);
        end

        h = h/2;
        R(1, :) = R(2, :);
    end

    res = R(2, n);
end
