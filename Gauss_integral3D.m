function result = Gauss_integral3D( lambda, target, it)
% INPUT: lambda is a column matrix
% directly implement the integral from 0 to 1, given lambda
% use five point Gauss in 3D, in total 125 evaluation point
% reach accuracy of at least 5-6 decimal point

% example: 
% Gauss_integral3D([1,0, 0, 0.2])
% Gauss_integral3D([3,3,0,0.01; 2,2,1,0.4;1,3,1,0.006])
% base function change of variable

global i1_i2_i3_m;

persistent zero_nodes_base_64 w_64 zero_nodes_base_32 w_32;

each_term = @(x1, x2, x3, i1, i2, i3, lambda) lambda * x1.^i1 .* x2.^i2 .* x3.^i3; 

% generate zero_node/weights in 3D space
w_64 =  [0.0486909570091397,0.0486909570091397,0.0485754674415034,0.0485754674415034,0.0483447622348030,0.0483447622348030,0.0479993885964583,0.0479993885964583,0.0475401657148303,0.0475401657148303,0.0469681828162100,0.0469681828162100,0.0462847965813144,0.0462847965813144,0.0454916279274181,0.0454916279274181,0.0445905581637566,0.0445905581637566,0.0435837245293235,0.0435837245293235,0.0424735151236536,0.0424735151236536,0.0412625632426235,0.0412625632426235,0.0399537411327203,0.0399537411327203,0.0385501531786156,0.0385501531786156,0.0370551285402400,0.0370551285402400,0.0354722132568824,0.0354722132568824,0.0338051618371416,0.0338051618371416,0.0320579283548516,0.0320579283548516,0.0302346570724025,0.0302346570724025,0.0283396726142595,0.0283396726142595,0.0263774697150547,0.0263774697150547,0.0243527025687109,0.0243527025687109,0.0222701738083833,0.0222701738083833,0.0201348231535302,0.0201348231535302,0.0179517157756973,0.0179517157756973,0.0157260304760247,0.0157260304760247,0.0134630478967186,0.0134630478967186,0.0111681394601311,0.0111681394601311,0.00884675982636390,0.00884675982636390,0.00650445796897840,0.00650445796897840,0.00414703326056250,0.00414703326056250,0.00178328072169640,0.00178328072169640];
zero_nodes_base_64 = 0.5+ 0.5* [-0.0243502926634244,0.0243502926634244,-0.0729931217877990,0.0729931217877990,-0.121462819296120,0.121462819296120,-0.169644420423992,0.169644420423992,-0.217423643740007,0.217423643740007,-0.264687162208767,0.264687162208767,-0.311322871990211,0.311322871990211,-0.357220158337668,0.357220158337668,-0.402270157963991,0.402270157963991,-0.446366017253464,0.446366017253464,-0.489403145707053,0.489403145707053,-0.531279464019894,0.531279464019894,-0.571895646202634,0.571895646202634,-0.611155355172393,0.611155355172393,-0.648965471254657,0.648965471254657,-0.685236313054233,0.685236313054233,-0.719881850171610,0.719881850171610,-0.752819907260531,0.752819907260531,-0.783972358943341,0.783972358943341,-0.813265315122797,0.813265315122797,-0.840629296252580,0.840629296252580,-0.865999398154092,0.865999398154092,-0.889315445995114,0.889315445995114,-0.910522137078502,0.910522137078502,-0.929569172131939,0.929569172131939,-0.946411374858402,0.946411374858402,-0.961008799652053,0.961008799652053,-0.973326827789911,0.973326827789911,-0.983336253884626,0.983336253884626,-0.991013371476744,0.991013371476744,-0.996340116771955,0.996340116771955,-0.999305041735772,0.999305041735772];

% 16
% zero_nodes_base_16 = 0.5 + 0.5* [  -0.9894,   -0.9446,   -0.8656,   -0.7554,   -0.6179,   -0.4580,   -0.2816,  -0.0950,    0.0950,    0.2816,    0.4580,    0.6179,    0.7554,    0.8656,    0.9446,    0.9894];
% w_16 =     [0.0272, 0.0623,    0.0952,    0.1246,    0.1496,    0.1692,    0.1826,    0.1895,    0.1895,    0.1826,    0.1692,    0.1496,    0.1246,    0.0952,    0.0623,    0.0272];

% 32
zero_nodes_base_32 = 0.5 + 0.5* [-0.997263861849481;-0.985611511545268;-0.964762255587506;-0.934906075937740;-0.896321155766052;-0.849367613732570;-0.794483795967943;-0.732182118740290;-0.663044266930215;-0.587715757240762;-0.506899908932229;-0.421351276130635;-0.331868602282128;-0.239287362252137;-0.144471961582796;-0.0483076656877383;0.0483076656877382;0.144471961582797;0.239287362252137;0.331868602282128;0.421351276130636;0.506899908932230;0.587715757240762;0.663044266930215;0.732182118740289;0.794483795967942;0.849367613732570;0.896321155766052;0.934906075937740;0.964762255587506;0.985611511545268;0.997263861849482];
w_32 = [0.00701861000947021;0.0162743947309057;0.0253920653092622;0.0342738629130214;0.0428358980222263;0.0509980592623761;0.0586840934785358;0.0658222227763623;0.0723457941088488;0.0781938957870697;0.0833119242269464;0.0876520930044040;0.0911738786957641;0.0938443990808043;0.0956387200792743;0.0965400885147276;0.0965400885147286;0.0956387200792749;0.0938443990808043;0.0911738786957646;0.0876520930044033;0.0833119242269462;0.0781938957870706;0.0723457941088490;0.0658222227763619;0.0586840934785352;0.0509980592623759;0.0428358980222264;0.0342738629130212;0.0253920653092626;0.0162743947309056;0.00701861000946989];

if it<5
    n=32;
else
    n=64;
end

[variable_size, ~] = size(i1_i2_i3_m);
zero_nodes = zeros(n^3, 3);
weights = zeros(1,n^3);
if it<5
    for i=1:n
        for j=1:n
            for k=1:n
                zero_nodes(n^2*(i-1)+n*(j-1)+(k),: ) = zero_nodes_base_32([ i, j, k]);
                weights(n^2*(i-1)+n*(j-1)+(k) )  = w_32(i)*w_32(j)*w_32(k);
            end
        end
    end
else 
    for i=1:n
        for j=1:n
            for k=1:n
                zero_nodes(n^2*(i-1)+n*(j-1)+(k),: ) = zero_nodes_base_64([ i, j, k]);
                weights(n^2*(i-1)+n*(j-1)+(k) )  = w_64(i)*w_64(j)*w_64(k);
            end
        end
    end
end

m = zero_nodes(:,1);
t = zero_nodes(:,2);
s = zero_nodes(:,3);
x1 = m;
x2 = (1-m).*t;
x3 = (1-m-(1-m).*t).*s;

change_variable_constant = (1-m).*(1-m-(1-m).*t);

f_val = zeros(n^3,1);
for i = 1: variable_size
    f_val = f_val + each_term( x1, x2, x3,  i1_i2_i3_m(i,1), i1_i2_i3_m(i,2), i1_i2_i3_m(i,3), lambda(i) );
end

if target=='f'
    preceding_term = ones(n.^3, 1);
    result = weights * ( exp(f_val) .* change_variable_constant .* preceding_term) /8 ; % final f
    result = result -  i1_i2_i3_m(:,4)' *  lambda;
elseif target=='g'
    g = zeros(variable_size, 1); % final g
    for i=1:variable_size
        preceding_term = prod( power( [x1,x2,x3] , i1_i2_i3_m(i,1:3)), 2);
        g(i) = weights * (exp(f_val) .* change_variable_constant .* preceding_term);
    end
    result = g / 8 -  i1_i2_i3_m(:, 4);
elseif target=='h'
    h = zeros(variable_size, variable_size);
    for i=1:variable_size
        for j=1:variable_size
            preceding_term = prod(power( [x1,x2,x3],  i1_i2_i3_m(i,1:3 )+ i1_i2_i3_m(j,1:3 )),2) ;
            h(i, j)= weights * (exp(f_val) .* change_variable_constant .* preceding_term);
        end
    end
    result = h / 8;
end



end